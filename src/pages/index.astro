---
import Layout from "../layouts/Layout.astro";
import StatCard from '../components/StatCard.astro';
import Chart from '../components/Chart.astro';
import RepositoryTable from '../components/RepositoryTable.astro';
import ContributorCards from '../components/ContributorCards.astro';
import Alert from '../components/Alert.astro';
import Loading from '../components/Loading.astro';
import { GitHubAnalytics } from '../utils/github';

// Fixed organization
const orgName = 'sakurai-lab-07';

// Get token from environment variables
const token = import.meta.env.GITHUB_TOKEN;

let analytics: GitHubAnalytics | undefined;
let orgStats: any = null;
let repoStats: any = null;
let contributorStats: any = null;
let commitActivity: any = null;
let error: string | null = null;

try {
  analytics = new GitHubAnalytics({ org: orgName, token: token || undefined });
  
  // Fetch all data
  [orgStats, repoStats, contributorStats, commitActivity] = await Promise.all([
    analytics.getOrganizationStats(),
    analytics.getRepositoryStats(),
    analytics.getContributorStats(),
    analytics.getCommitActivity(30)
  ]);
} catch (err: any) {
  console.error('Error fetching GitHub data:', err);
  
  if (err.status === 401) {
    error = 'GitHub APIの認証に失敗しました。Personal Access Tokenが正しく設定されているか確認してください。';
  } else if (err.status === 404) {
    error = `Organization "${orgName}" が見つかりません。`;
  } else if (err.status === 403) {
    error = 'APIレート制限に達しました。しばらく待ってから再度お試しください。';
  } else {
    error = `データの取得中にエラーが発生しました: ${err.message || '予期しないエラー'}`;
  }
}

// Prepare chart data
let commitChartData: any = null;
let languageChartData: any = null;
let contributorChartData: any = null;
let activityChartData: any = null;

if (!error && commitActivity && repoStats && contributorStats && orgStats) {
  // Commit activity over time
  const commitsByDate: Record<string, number> = commitActivity.reduce((acc: Record<string, number>, commit: any) => {
    acc[commit.date] = (acc[commit.date] || 0) + 1;
    return acc;
  }, {});

  const sortedDates = Object.keys(commitsByDate).sort();
  commitChartData = {
    labels: sortedDates.map(date => new Date(date).toLocaleDateString('ja-JP')),
    datasets: [{
      label: 'コミット数',
      data: sortedDates.map(date => commitsByDate[date]),
      borderColor: '#667eea',
      backgroundColor: 'rgba(102, 126, 234, 0.1)',
      fill: true,
      tension: 0.4
    }]
  };

  // Languages distribution
  const languageStats: Record<string, number> = repoStats.reduce((acc: Record<string, number>, repo: any) => {
    const lang = repo.language || 'Unknown';
    acc[lang] = (acc[lang] || 0) + 1;
    return acc;
  }, {});

  languageChartData = {
    labels: Object.keys(languageStats),
    datasets: [{
      data: Object.values(languageStats),
      backgroundColor: [
        '#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b',
        '#fa709a', '#fee140', '#ff9a9e', '#a8edea', '#fad0c4'
      ]
    }]
  };

  // Top contributors
  const topContributors = contributorStats.slice(0, 10);
  contributorChartData = {
    labels: topContributors.map((c: any) => c.login),
    datasets: [{
      label: 'コミット数',
      data: topContributors.map((c: any) => c.commits),
      backgroundColor: '#667eea',
      borderColor: '#4f46e5',
      borderWidth: 1
    }]
  };

  // Activity trend (last 7 days)
  const recentActivity = sortedDates.slice(-7);
  activityChartData = {
    labels: recentActivity.map(date => new Date(date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })),
    datasets: [{
      label: '最近のアクティビティ',
      data: recentActivity.map(date => commitsByDate[date]),
      backgroundColor: 'rgba(102, 126, 234, 0.8)',
      borderColor: '#667eea',
      borderWidth: 2
    }]
  };
}
---

<Layout>
  <div class="min-h-screen bg-gradient-to-br from-gray-50 to-white">
    <!-- Header -->
    <header class="border-b border-gray-200 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
      <div class="container">
        <div class="flex items-center justify-between py-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center">
              <i class="fab fa-github text-white text-lg"></i>
            </div>
            <div>
              <h1 class="text-xl font-bold text-gray-900">Sakurai Lab 07</h1>
              <p class="text-sm text-gray-500">GitHub Analytics Dashboard</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="badge badge-success">
              <i class="fas fa-circle text-xs"></i>
              Live Data
            </span>
          </div>
        </div>
      </div>
    </header>

    <main class="container py-8">
      {error && (
        <Alert type="error" message={error} />
      )}

      {!error && orgStats && (
        <>
          <!-- Hero Stats - Bento Grid Style -->
          <section class="mb-12">
            <div class="text-center mb-8">
              <h2 class="text-3xl font-bold text-gray-900 mb-2">Organization Overview</h2>
              <p class="text-gray-600">Real-time insights into repository activity and contributions</p>
            </div>
            
            <div class="bento-grid">
              <!-- Large Primary Stat -->
              <div class="bento-card bento-large">
                <div class="bento-content">
                  <div class="bento-icon-large">
                    <i class="fas fa-code-branch"></i>
                  </div>
                  <div class="bento-main-value">{orgStats.totalRepositories}</div>
                  <div class="bento-main-label">Total Repositories</div>
                  <div class="bento-description">Active and archived projects</div>
                </div>
                <div class="bento-accent"></div>
              </div>
              
              <!-- Secondary Stats -->
              <div class="bento-card bento-medium">
                <div class="bento-content">
                  <div class="bento-icon">
                    <i class="fa-solid fa-code-commit"></i>
                  </div>
                  <div class="bento-value">{orgStats.totalCommits.toLocaleString()}</div>
                  <div class="bento-label">Total Commits</div>
                </div>
              </div>
              
              <div class="bento-card bento-small">
                <div class="bento-content">
                  <div class="bento-icon">
                    <i class="fas fa-users"></i>
                  </div>
                  <div class="bento-value">{orgStats.totalContributors}</div>
                  <div class="bento-label">Contributors</div>
                </div>
              </div>
                <!-- Feature Card -->
              <div class="bento-card bento-wide">
                <div class="bento-content-horizontal">
                  <div class="bento-metric">
                    <div class="bento-icon">
                      <i class="fas fa-star"></i>
                    </div>
                    <div>
                      <div class="bento-value">{orgStats.totalStars.toLocaleString()}</div>
                      <div class="bento-label">Stars</div>
                    </div>
                  </div>
                  <div class="bento-metric">
                    <div class="bento-icon">
                      <i class="fas fa-code-branch"></i>
                    </div>
                    <div>
                      <div class="bento-value">{orgStats.totalForks.toLocaleString()}</div>
                      <div class="bento-label">Forks</div>
                    </div>
                  </div>
                </div>
                <div class="bento-accent-wide"></div>
              </div>
            </div>
          </section>

          <!-- Charts Grid -->
          <section class="mb-12">
            <div class="grid lg:grid-cols-2 gap-8">
              {commitChartData && (
                <div class="chart-card">
                  <Chart 
                    type="line" 
                    data={commitChartData} 
                    title="Commit Activity (Last 30 Days)"
                    id="commit-chart"
                  />
                </div>
              )}

              {languageChartData && (
                <div class="chart-card">
                  <Chart 
                    type="doughnut" 
                    data={languageChartData}
                    title="Language Distribution"
                    id="language-chart"
                  />
                </div>
              )}

              {contributorChartData && (
                <div class="chart-card lg:col-span-2">
                  <Chart 
                    type="bar" 
                    data={contributorChartData}
                    title="Top Contributors"
                    id="contributor-chart"
                  />
                </div>
              )}
            </div>
          </section>

          <!-- Detailed Sections -->
          <div class="grid lg:grid-cols-1 gap-8">
            {repoStats && (
              <section class="card">
                <div class="card-body p-0">
                  <RepositoryTable repositories={repoStats} />
                </div>
              </section>
            )}

            {contributorStats && (
              <section class="card">
                <div class="card-body p-0">
                  <ContributorCards contributors={contributorStats.slice(0, 12)} />
                </div>
              </section>
            )}
          </div>
        </>
      )}

      {!error && !orgStats && (
        <div class="flex items-center justify-center min-h-[400px]">
          <Loading message="Loading analytics data..." />
        </div>
      )}
    </main>  </div>
</Layout>

<style>
  @import "../styles/bento-grid.css";
  @import "../styles/index.css";
</style>


